# =============================================================================
# @cognigy/chat-components-vue - Prepare Release
# =============================================================================
# Automatically prepares a release PR when code is merged to main:
# - Minor version bump (0.x.0 → 0.(x+1).0) for regular PRs
# - Patch version bump (0.x.y → 0.x.(y+1)) for Dependabot PRs
#
# Creates a release PR instead of pushing directly to main to comply with
# branch protection rules.
#
# Version scheme: 0.x.x (pre-1.0 semver)
# =============================================================================

name: Prepare Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'package.json'
      - 'package-lock.json'
      - 'CHANGELOG.md'
      - '**.md'
      - '.github/workflows/**'
      - 'plans/**'
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        type: choice
        options:
          - minor
          - patch
        default: minor

jobs:
  prepare-release:
    name: Prepare Release PR
    runs-on: ubuntu-latest

    # Don't run on commits made by this workflow or version bump commits
    # Allow manual triggers (workflow_dispatch) - head_commit is null in that case
    if: >-
      github.event_name == 'workflow_dispatch' || (
        !contains(github.event.head_commit.message || '', '[skip ci]') &&
        !contains(github.event.head_commit.message || '', 'chore: bump version') &&
        !contains(github.event.head_commit.message || '', 'chore: release')
      )

    permissions:
      contents: write
      pull-requests: write

    steps:
      # ----------------------------------------------------------------------
      # Checkout with full history for proper git operations
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: ${{ github.event.repository.default_branch }}  # Always use default branch as source, even when triggered from other branches
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------------------
      # Setup Node.js (match engines requirement)
      # ----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'

      # ----------------------------------------------------------------------
      # Configure Git
      # ----------------------------------------------------------------------
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ----------------------------------------------------------------------
      # Determine version bump type
      # ----------------------------------------------------------------------
      - name: Determine bump type
        id: bump-type
        run: |
          # For manual triggers (workflow_dispatch), use the selected input
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BUMP_TYPE="${{ github.event.inputs.bump_type }}"
            echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
            echo "Manual trigger - will bump ${BUMP_TYPE^^} version"
            exit 0
          fi

          # Check if this is a Dependabot commit
          COMMIT_AUTHOR="${{ github.event.head_commit.author.username }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"

          echo "Commit author: $COMMIT_AUTHOR"
          echo "Commit message: $COMMIT_MESSAGE"

          if [[ "$COMMIT_AUTHOR" == "dependabot[bot]" ]] || [[ "$COMMIT_MESSAGE" == *"dependabot"* ]] || [[ "$COMMIT_MESSAGE" == *"Bump "* ]]; then
            echo "bump_type=patch" >> $GITHUB_OUTPUT
            echo "Detected Dependabot commit - will bump PATCH version"
          else
            echo "bump_type=minor" >> $GITHUB_OUTPUT
            echo "Regular commit - will bump MINOR version"
          fi

      # ----------------------------------------------------------------------
      # Get current version
      # ----------------------------------------------------------------------
      - name: Get current version
        id: current-version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      # ----------------------------------------------------------------------
      # Calculate new version
      # ----------------------------------------------------------------------
      - name: Calculate new version
        id: new-version
        run: |
          CURRENT="${{ steps.current-version.outputs.current_version }}"
          BUMP_TYPE="${{ steps.bump-type.outputs.bump_type }}"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Handle pre-release suffixes (e.g., 0.1.0-beta.1)
          PATCH_NUM="${PATCH%%-*}"

          if [[ "$BUMP_TYPE" == "patch" ]]; then
            NEW_PATCH=$((PATCH_NUM + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          else
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="$MAJOR.$NEW_MINOR.0"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION (bump type: $BUMP_TYPE)"

      # ----------------------------------------------------------------------
      # Check if release PR already exists
      # ----------------------------------------------------------------------
      - name: Check for existing release PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          BRANCH_NAME="release/v$NEW_VERSION"

          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists"
            echo "pr_exists=true" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------------------------
      # Create release branch
      # ----------------------------------------------------------------------
      - name: Create release branch
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          BRANCH_NAME="release/v$NEW_VERSION"

          git checkout -b "$BRANCH_NAME"
          echo "Created branch: $BRANCH_NAME"

      # ----------------------------------------------------------------------
      # Update package.json version
      # ----------------------------------------------------------------------
      - name: Update package.json version
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"

          # Update version in package.json using npm
          npm version $NEW_VERSION --no-git-tag-version --allow-same-version

          echo "Updated package.json to version $NEW_VERSION"

      # ----------------------------------------------------------------------
      # Update CHANGELOG.md
      # ----------------------------------------------------------------------
      - name: Update CHANGELOG
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          CURRENT_DATE=$(date +%Y-%m-%d)
          BUMP_TYPE="${{ steps.bump-type.outputs.bump_type }}"

          # Check if CHANGELOG.md exists
          if [ ! -f "CHANGELOG.md" ]; then
            echo "CHANGELOG.md not found - creating new one"
            cat > CHANGELOG.md << 'HEREDOC'
          # Changelog

          All notable changes to this project will be documented in this file.

          HEREDOC
          fi

          # Create changelog entry based on bump type
          if [[ "$BUMP_TYPE" == "patch" ]]; then
            CHANGE_NOTE="- Dependency updates"
          else
            CHANGE_NOTE="- See commit history for changes"
          fi

          # Prepend new version entry after the header
          TEMP_FILE=$(mktemp)
          {
            head -n 4 CHANGELOG.md
            echo ""
            echo "## [$NEW_VERSION] - $CURRENT_DATE"
            echo ""
            echo "### Changed"
            echo "$CHANGE_NOTE"
            echo ""
            tail -n +5 CHANGELOG.md
          } > "$TEMP_FILE"
          mv "$TEMP_FILE" CHANGELOG.md

          echo "Updated CHANGELOG.md with version $NEW_VERSION"

      # ----------------------------------------------------------------------
      # Commit and push release branch
      # ----------------------------------------------------------------------
      - name: Commit and push release branch
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          BUMP_TYPE="${{ steps.bump-type.outputs.bump_type }}"
          BRANCH_NAME="release/v$NEW_VERSION"

          git add package.json package-lock.json CHANGELOG.md 2>/dev/null || git add package.json CHANGELOG.md

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: bump version to $NEW_VERSION ($BUMP_TYPE)"
          git push origin "$BRANCH_NAME"

          echo "Pushed release branch: $BRANCH_NAME"

      # ----------------------------------------------------------------------
      # Create Pull Request
      # ----------------------------------------------------------------------
      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          CURRENT_VERSION="${{ steps.current-version.outputs.current_version }}"
          BUMP_TYPE="${{ steps.bump-type.outputs.bump_type }}"
          BRANCH_NAME="release/v$NEW_VERSION"

          # Generate PR body
          PR_BODY=$(cat << EOF
          ## Release v$NEW_VERSION

          **Release Type:** $(echo $BUMP_TYPE | tr '[:lower:]' '[:upper:]')
          **Previous Version:** $CURRENT_VERSION

          ### Changes
          - Version bump: $CURRENT_VERSION → $NEW_VERSION
          - Updated CHANGELOG.md

          ### What happens when this PR is merged?
          1. The \`auto-tag.yml\` workflow will automatically create tag \`v$NEW_VERSION\`
          2. The \`publish.yml\` workflow will be triggered by the tag
          3. The package will be published to npm

          ---
          *Automated release PR created by GitHub Actions*
          EOF
          )

          gh pr create \
            --title "chore: release v$NEW_VERSION" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "release"

          echo "Created release PR for v$NEW_VERSION"

      # ----------------------------------------------------------------------
      # Summary
      # ----------------------------------------------------------------------
      - name: Summary
        if: always()
        run: |
          NEW_VERSION="${{ steps.new-version.outputs.new_version }}"
          PR_EXISTS="${{ steps.check-pr.outputs.pr_exists }}"

          echo "# Prepare Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "$PR_EXISTS" == "true" ]]; then
            echo "Release PR for v$NEW_VERSION already exists. Skipping." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Version Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Previous Version** | \`${{ steps.current-version.outputs.current_version }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **New Version** | \`$NEW_VERSION\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Bump Type** | \`${{ steps.bump-type.outputs.bump_type }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Release Branch** | \`release/v$NEW_VERSION\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the release PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Merge when ready" >> $GITHUB_STEP_SUMMARY
            echo "3. Tag will be created automatically" >> $GITHUB_STEP_SUMMARY
            echo "4. Package will be published to npm" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Automated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
